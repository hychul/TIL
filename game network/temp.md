# TCP vs UDP

UDP가 속도가 빠르기 때문에 게임에서 UDP를 선호한다. 
보통 UDP의 손실률이 7%정도 된다.
때문에 일반적으로 커스텀하여 RUDP를 만들어서 사용한다.

TCP 사용 게임 : MMORPG, 보드게임
UDP 사용 게임 : 액션, 격투, 슈팅, FPS, AOS, RTS


# Deterministric vs Server Authority

데이터의 활용 방식이기 때문에 프로토콜과 직접적인 관련은 없다.

Deterministic은 UDP에서 많이 사용, 반응성이 높은 게임

Server Authority는 TCP에서 많이 사용, 서버에 권한이 있어 보안성이 높은 게임

## Deterministic

같은 시간에 같은 입력이 들어가면 같은 결과를 낸다. 

두 사용자가 온라인에서 접속했을 때, 같은 입력값을 두 사용자의 컴퓨터에 보내는 방식이다. 두 사용자 간의 지연 시간을 극복하여 같은 시간에 같은 입력을 두 컴퓨터에 전달한다.

이런 지연 시간을 극복하는 방법은 크게 두가지가 있다.

### Delay

A와 B사용자가 있을 떄 각각의 사용자가 입력을 했을 때 서로에게 입력값이 전달되는 지연시간은 일반적으로 같다. 때문에 서로에게 전달되는 지연시간 만큼 자신의 입력값도 지연<sup>Delay</sup>시켜 처리하면 같은 시간에 같은 입력값을 처리하여 싱크가 맞춰진다.

하지만 자신의 입력도 지연되기 때문에 게임의 반응성이 떨어진다.

>> 지연시간이 100ms 이상 부터는 일반인들도 지연을 감지한다.

### Rollback

롤백 방식은 지연시간과 상관없이 자신의 입력이 들어온 경우 그 입력을 처리한다. 그리고 상대방의 입력을 받았을 때 온 그 입력을 계산하여 자신의 입력에 대한 결과와 비교한다. 즉 상대방의 입력을 지연시간 만큼 되돌려<sup>Rollback</sup> 결과를 구한다음 자신의 입력의 결과와 비교하여 싱크를 맞춘다.

롤백 방식의 문제점은 상대의 입력이 들어올 때 마다 지연시간 만큼 되돌려진 화면으로 전환되기 때문에 프레임이 연속적이지 않는 것처럼 보이게 된다. 마치 렉이 걸린 것 처럼 보이는 것이다. 그리고 Delay 방식보다 구현이 어렵다.

때문에 롤백 방식은 일반적으로 제한적으로 사용된다.

오버워치나 브롤 스타즈에서 빠른 반응성을 위해 자신의 캐릭터에 애니메이션에 대해서만 제한적으로 사용된다.

### P2P vs Relay

각 클라이언트간의 연결이 어떻게 형성되는지에 대한 방식이다.

#### Relay

사용자간의 데이터 전송을 중계 서버<sup>Relay Server</sup>을 통해서 전달하는 방식이다. 

이를 통해서 Deterministic의 Delay방식을 사용한다면 클라이언트에서 지연 시간에 대한 계산을 할 필요 없이 모든 입력을 서버로 보내고, 서버로부터 입력을 브로드캐스팅 되었을 때 모든 클라이언트가 입력을 처리하면 된다.

#### P2P 

클라이언트간의 연결을 직접 형성한다. 

##### IP와 P2P의 한계

IPv4가 먼저 개발되고 IP 주소가 부족할 것을 걱정하여 IPv6라는 표준이 개발되었지만 IP 매핑 기술이 생기면서 IPv4로도 게이트웨이 라우팅을 통한 한정적인 IP를 통해서 통신을 할 수 있도록 되었다.

게이트웨이 내부의 클라이언트에서 나가는 패킷이 생길때 게이트웨이의 임의의 포트, 내부 클라이언트 주소, 패킷 목적지 주소를 바인딩하여 맵핑 테이블에 추가하여 목적지에서 온 응답을 내부 클라이언트에 전달한다. 때문에 외부 게이트 웨이에선 내부 클라이언트에 직접적으로 접근할 수 없다. 이런 역할을 하는 게이트웨이를 NAT이라고 한다.

위처럼 NAT를 거치는 경우, P2P 연결을 위해 서로의 클라이언트간의 연결을 생성할 수 없다. 때문에 고정 IP를 갖는 서버를 통해 연결을 생성하고 각 클라이언트가 각 클라이언트의 NAT에서 생성한 맵핑테이블에 생성된 바인딩 정보를 통해서 클라이언트가 직접 연결되게 할 수 있다. 이렇게 NAT에 생성된 클라이언트의 public IP를 상대방에게 알려주는 서버를 STUN 서버라고한다.

하지만 게이트웨이에서 목적지의 주소가 변경되었기 때문에 이를 거부 할 가능성이 있기 때문에 이를 주의해야한다. 

일반적으로는 이를 신경쓰지 않고 연결을 생성할 수 있는데 이 방식을 홀펀칭이라고 한다.

홀펀칭이 실패한 경우 고정 IP 갖는 중계 서버를 사용할 수 밖에 없다. 이런 홀펀팅에 실패한 연결을 중계하는 서버를 TURN 서버라고 한다.

### Deterministic의 한계

입력값을 기준으로 사용자간의 싱크를 맞추는 방식이기 때문에 사용자간의 상태를 저장하지 않는다. 때문에 접속이 끊어졌다가 다시 접속하는 경우 한 게임에 대해서 처음부터 다시 접속했을 때까지의 모든 입력을 저장했다가 이를 모두 계산하여 상태를 업데이트 해줘야 한다.

그리고 싱크가 안된 상태가 발생하지 않도록 유의해야한다.

### Deterministic과 해킹

입력값을 사용하기 때문에 해킹에 취약하다. 때문에 전달 받은 입력값을 검증하는 프로세스가 필요하다.

## Server Authority

서버가 클라이언트와 프로세스를 중재하는 역할을 하는 방식이다. 

서버가 로직을 수행하기 때문에 모든 클라이언트에 대한 정보와 월드에 대한 컨트롤을 얼마나 처리할 수 있으냐가 관건이다. 일반적으로 10K Server를 이상적인 서버로 생각하여, 효율적인 실시간 서버를 만들 수 있도록 해야한다.

# IOCP vs Select

둘 모두 서버에서 Socket을 비동기로 사용하는 방식을 의미한다.

## Select

IO가 있을 때 사용할 수 있는지 계속 확인하는 방식이다.

## IOCP

IO 처리에 대해서 OS에 요청을 하고 바로 커서를 리턴 받아 다른 일을 처리하는 방식이다.

